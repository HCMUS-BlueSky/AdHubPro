<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AdHubPro</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .marker {
        background-image: url("https://docs.mapbox.com/help/demos/custom-markers-gl-js/mapbox-icon.png");
        background-size: cover;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
      }
      .mapboxgl-popup {
        max-width: 200px;
      }
      .mapboxgl-popup-content {
        text-align: center;
        font-family: "Open Sans", sans-serif;
      }
    </style>
  </head>
  <body>
    <!-- Load the `mapbox-gl-geocoder` plugin. -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <style>
      /* Side bar */
      .rounded-rect {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 50px -25px black;
      }

      .flex-center {
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .flex-center.left {
        left: 0px;
      }

      .sidebar-content {
        position: absolute;
        width: 95%;
        height: 95%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 32px;
        color: gray;
      }

      .sidebar-toggle {
        position: absolute;
        width: 1.3em;
        height: 1.3em;
        overflow: visible;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .sidebar-toggle.left {
        right: -1.5em;
      }

      .sidebar-toggle:hover {
        color: #0aa1cf;
        cursor: pointer;
      }

      .sidebar {
        transition: transform 1s;
        z-index: 1;
        width: 300px;
        height: 100%;
      }

      /*
      The sidebar styling has them "expanded" by default, we use CSS transforms to push them offscreen
      The toggleSidebar() function removes this class from the element in order to expand it.
      */
      .left.collapsed {
        transform: translateX(-295px);
      }
    </style>

    <div id="map">
      <div id="left" class="sidebar flex-center left collapsed">
        <div class="sidebar-content rounded-rect flex-center">
          Left Sidebar
          <div
            class="sidebar-toggle rounded-rect left"
            onclick="toggleSidebar('left')"
          >
            &rarr;
          </div>
        </div>
      </div>
    </div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1Ijoibm1raG9pMjEiLCJhIjoiY2xvMno5ZzhyMGQzdTJ2bGVkbTc4bGZ5dSJ9.9ljGVzjte5iqJXpbOiAN1Q";
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [106.68247166663183, 10.762993690850745],
        zoom: 15,
      });
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        reverseGeocode: true,
        flipCoordinates: true,
        marker: {
          color: 'red'
        },
        flyTo: {
          bearing: 0,
          animate: true,
          duration: 750,
          speed: 1,
          essential: true,
          curve: 1,
          easing: function (t) {
            return Math.sin((t * Math.PI) / 2);
          }
        }
      })
      map.addControl(geocoder);
      let currentMarker = null;
      // Fetch locations data
      async function logLocations() {
        const response = await fetch("http://localhost:4000/api/location");
        const locations = await response.json();
        return locations;
      }

      async function addMarker(x,y) {
        if (currentMarker) {
          currentMarker.remove();
        }
        const el = document.createElement('div');
        el.className = 'marker';
        currentMarker = new mapboxgl.Marker(el)
        .setLngLat([x,y])
        .addTo(map);
      }
      // Side bar
      function toggleSidebar(id) {
        const elem = document.getElementById(id);
        // Add or remove the 'collapsed' CSS class from the sidebar element.
        // Returns boolean "true" or "false" whether 'collapsed' is in the class list.
        const collapsed = elem.classList.toggle("collapsed");
        const padding = {};
        // 'id' is 'right' or 'left'. When run at start, this object looks like: '{left: 300}';
        padding[id] = collapsed ? 0 : 300; // 0 if collapsed, 300 px if not. This matches the width of the sidebars in the .sidebar CSS class.
        // Use `map.easeTo()` with a padding option to adjust the map's center accounting for the position of sidebars.
        map.easeTo({
          padding: padding,
          duration: 1000, // In ms. This matches the CSS transition duration property.
        });
      }
     
      
      async function initMap() {
        const locations = await logLocations();
        const geojson = {
          type: "FeatureCollection",
          features: [],
        };
        locations.map((location) => {
          const feature = {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [location.longitude, location.latitude],
            },
            properties: {
              method: location.method,
              type: location.type,
              address: location.address,
              status: location.accepted ? "Đã quy hoạch" : "Chưa quy hoạch",
            },
          };
          geojson.features.push(feature);
        });


        map.on("load", () => {
          map.addSource("AdsLocations", {
            type: "geojson",
            data: geojson,
            cluster: true,
            clusterMaxZoom: 35,
            clusterRadius: 50,
          });

          map.addLayer({
            id: "clusters",
            type: "circle",
            source: "AdsLocations",
            filter: ["has", "point_count"],
            paint: {
              "circle-color": [
                "step",
                ["get", "point_count"],
                "#51bbd6",
                10,
                "#f1f075",
                30,
                "#f28cb1",
              ],
              "circle-radius": [
                "step",
                ["get", "point_count"],
                20,
                100,
                30,
                750,
                40,
              ],
            },
          });

          map.addLayer({
            id: "cluster-count",
            type: "symbol",
            source: "AdsLocations",
            filter: ["has", "point_count"],
            layout: {
              "text-field": ["get", "point_count_abbreviated"],
              "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
              "text-size": 12,
            },
          });

          map.addLayer({
            id: "unclustered-point",
            type: "circle",
            source: "AdsLocations",
            filter: ["!", ["has", "point_count"]],
            paint: {
              "circle-color": "#11b4da",
              "circle-radius": 15,
              "circle-stroke-width": 1,
              "circle-stroke-color": "#fff",
            },
          });

          map.addLayer({
            id: "cluster-ads",
            type: "symbol",
            source: "AdsLocations",
            filter: ["!", ["has", "point_count"]],
            layout: {
              "text-field": "QC",
              "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
              "text-size": 12,
            },
          });

          map.on("click", "clusters", (e) => {
            e.clickOnLayer = true;
            const features = map.queryRenderedFeatures(e.point, {
              layers: ["clusters"],
            });
            const clusterId = features[0].properties.cluster_id;
            map
              .getSource("AdsLocations")
              .getClusterExpansionZoom(clusterId, (err, zoom) => {
                if (err) return;

                map.easeTo({
                  center: features[0].geometry.coordinates,
                  zoom: zoom,
                });
              });
          });

          const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
          });

          map.on("mouseenter", "unclustered-point", (e) => {
            map.getCanvas().style.cursor = "pointer";
            const coordinates = e.features[0].geometry.coordinates.slice();

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            popup
              .setLngLat(coordinates)
              .setHTML(
                `<h2>${e.features[0].properties.method}</h2>
                <p>${e.features[0].properties.type}</p>
                <p>${e.features[0].properties.address}</p>
                <h2>${e.features[0].properties.status}</h2>`
              )
              .addTo(map);
          });

          map.on("mouseleave", "unclustered-point", () => {
            map.getCanvas().style.cursor = "";
            popup.remove();
          });

          map.on("mouseenter", "clusters", () => {
            map.getCanvas().style.cursor = "pointer";
          });
          map.on("mouseleave", "clusters", () => {
            map.getCanvas().style.cursor = "";
          });
          
          // Reverse geocoding
          map.on("click", (e) => {
            if (e.clickOnLayer) {
              return;
            }
            let m = e.lngLat.wrap();
            geocoder.query(`${m.lng}, ${m.lat}`);
          })
          geocoder.on('result', (event) => {
            // console.log(event)
          });
        });
        

        // Add the control to the map and search bar.
        // map.addControl(
        //   new MapboxGeocoder({
        //     accessToken: mapboxgl.accessToken,
        //     mapboxgl: mapboxgl,
        //   })
        // );

        // Add geolocate control to the map.
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: {
              enableHighAccuracy: true,
            },
            // When active the map will receive updates to the device's location as it changes.
            trackUserLocation: true,
            // Draw an arrow next to the location dot to indicate which direction the device is heading.
            showUserHeading: true,
          })
        );
      }
      
      initMap();
    </script>
  </body>
</html>
